#!/usr/bin/env bash
# This script audits DNS records for specific subdomains of a domain and prints their record type and destination.

query_sub() {
  local domain="$1"
  local sub="$2"
  local fq="${sub}.${domain}"

  # Prefer a direct A lookup against a public resolver to avoid local cache/formatting issues
  local dest record answer
  dest=$(dig +short "${fq}" A @8.8.8.8 | head -n1)

  if [ -n "${dest}" ]; then
    record="A"
    echo "The subdomain ${sub} is a ${record} record and points to ${dest}"
    return
  fi

  # Fallback: try any answer and parse it (handles non-A records)
  answer=$(dig +nocmd "${fq}" any +noall +answer | head -n1)
  if [ -n "${answer}" ]; then
    record=$(echo "${answer}" | awk '{for(i=1;i<=NF;i++) if($i=="IN"){print $(i+1); exit}}')
    dest=$(echo "${answer}" | awk '{print $NF}')
    if [ -n "${record}" ] && [ -n "${dest}" ]; then
      echo "The subdomain ${sub} is a ${record} record and points to ${dest}"
      return
    fi
  fi

  # No records found
  echo "The subdomain ${sub} has no DNS record (NOT_FOUND)"
}

main() {
  local domain="$1"
  local sub="$2"

  if [ -z "$domain" ]; then
    echo "Usage: $0 domain [subdomain]"
    exit 1
  fi

  if [ -z "$sub" ]; then
    for s in www lb-01 web-01 web-02; do
      query_sub "$domain" "$s"
    done
  else
    query_sub "$domain" "$sub"
  fi
}

main "$@"
